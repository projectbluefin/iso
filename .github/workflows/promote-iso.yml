---
name: Promote ISOs to Production
on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Which ISOs to promote'
        required: true
        type: choice
        default: 'stable'
        options:
          - stable
          - lts
          - all
      release_tag:
        description: 'GitHub release tag to promote (e.g., 26.02.1). Leave empty to auto-detect latest prerelease.'
        type: string
        required: false
      dry_run:
        description: 'Run in dry-run mode (preview changes without copying)'
        required: false
        type: boolean
        default: true

jobs:
  promote:
    name: Promote ${{ inputs.variant }} ISOs to Production
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      # Test Bucket Config (Source) - using R2 2025 credentials
      RCLONE_CONFIG_R2_TEST_TYPE: s3
      RCLONE_CONFIG_R2_TEST_PROVIDER: Cloudflare
      RCLONE_CONFIG_R2_TEST_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID_2025 }}
      RCLONE_CONFIG_R2_TEST_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY_2025 }}
      RCLONE_CONFIG_R2_TEST_REGION: auto
      RCLONE_CONFIG_R2_TEST_ENDPOINT: ${{ secrets.R2_ENDPOINT_2025 }}

      # Production Bucket Config (Destination) - using dedicated production credentials
      RCLONE_CONFIG_R2_PROD_TYPE: s3
      RCLONE_CONFIG_R2_PROD_PROVIDER: Cloudflare
      RCLONE_CONFIG_R2_PROD_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_PRODUCTION }}
      RCLONE_CONFIG_R2_PROD_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_PRODUCTION }}
      RCLONE_CONFIG_R2_PROD_REGION: auto
      RCLONE_CONFIG_R2_PROD_ENDPOINT: ${{ secrets.R2_ENDPOINT_PRODUCTION }}

    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install rclone
        run: brew install rclone

      - name: Determine filter pattern
        id: filter
        run: |
          case "${{ inputs.variant }}" in
            stable)
              echo "filter=--include *-stable-*.iso*" >> $GITHUB_OUTPUT
              ;;
            lts)
              echo "filter=--include *-lts-*.iso* --include *-lts-hwe-*.iso* --include *-dx-lts-*.iso*" >> $GITHUB_OUTPUT
              ;;
            all)
              echo "filter=--include *.iso --include *.iso-CHECKSUM --include *.iso.torrent --include *.iso.torrent-CHECKSUM" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: List files in Test bucket
        run: |
          echo "Files in Test bucket matching variant '${{ inputs.variant }}':"
          rclone ls R2_TEST:testing ${{ steps.filter.outputs.filter }}

      - name: Promote ISOs (Dry Run)
        if: inputs.dry_run == true
        run: |
          echo "Running in DRY RUN mode - no files will be copied"
          rclone sync R2_TEST:testing R2_PROD:bluefin \
            ${{ steps.filter.outputs.filter }} \
            --dry-run \
            --verbose

      - name: Promote ISOs (Production)
        if: inputs.dry_run == false
        run: |
          echo "Promoting ISOs from Test to Production"
          rclone sync R2_TEST:testing R2_PROD:bluefin \
            ${{ steps.filter.outputs.filter }} \
            --verbose \
            --progress

      - name: Verify promotion
        if: inputs.dry_run == false
        run: |
          echo "Files in Production bucket after promotion:"
          rclone ls R2_PROD:bluefin ${{ steps.filter.outputs.filter }}

  promote-release:
    name: Promote GitHub Release
    needs: promote
    if: inputs.dry_run == false
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Determine release tag
        id: tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -eoux pipefail
          if [ -n "${{ inputs.release_tag }}" ]; then
            TAG="${{ inputs.release_tag }}"
          else
            # Auto-detect latest prerelease
            TAG=$(gh release list --limit 20 --json tagName,isPrerelease --jq '.[] | select(.isPrerelease == true) | .tagName' | head -n1)
            if [ -z "$TAG" ]; then
              echo "No prerelease found to promote"
              exit 1
            fi
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Promoting release: ${TAG}"

      - name: Update release to full release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          set -eoux pipefail

          # Edit release to remove prerelease flag and mark as latest
          gh release edit "${TAG}" \
            --prerelease=false \
            --latest \
            --title "Bluefin ISOs ${TAG}"

          # Update release notes
          gh release edit "${TAG}" --notes "$(cat <<'EOF'
          ## âœ… Production Release

          These ISOs have been validated and promoted to production.

          **Status**: Production-ready
          **Available at**: https://download.projectbluefin.io/

          ### How to Download

          1. Download a `.torrent` file below
          2. Open with a BitTorrent client (qBittorrent, Transmission, etc.)
          3. Torrents include web seeds from production CDN

          ### Direct Downloads

          ISOs are available at https://download.projectbluefin.io/

          ### Verify

          ```bash
          sha256sum -c <filename>.torrent-CHECKSUM
          ```
          EOF
          )"

          echo "Successfully promoted release ${TAG} to production"
