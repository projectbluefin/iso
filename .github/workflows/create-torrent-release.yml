---
name: Create Torrent Release
# Automatically creates a GitHub Release with .torrent files
# after a successful ISO build workflow completes.
on:
  workflow_run:
    workflows:
      - "Build Stable ISOs"
      - "Build LTS ISOs"
      - "Build LTS-HWE ISOs"
      - "Build All ISOs"
    types:
      - completed

jobs:
  create-release:
    name: Create Torrent Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
    env:
      RCLONE_CONFIG_R2_TYPE: s3
      RCLONE_CONFIG_R2_PROVIDER: Cloudflare
      RCLONE_CONFIG_R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID_2025 }}
      RCLONE_CONFIG_R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY_2025 }}
      RCLONE_CONFIG_R2_REGION: auto
      RCLONE_CONFIG_R2_ENDPOINT: ${{ secrets.R2_ENDPOINT_2025 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install rclone
        run: brew install rclone

      - name: Download Torrent Files from R2
        run: |
          set -eoux pipefail
          mkdir -p torrents
          rclone copy R2:testing torrents \
            --include "*.iso.torrent" \
            --include "*.iso.torrent-CHECKSUM" \
            --log-level INFO

          echo "Downloaded torrent files:"
          ls -lh torrents/

          if [ -z "$(ls torrents/*.torrent 2>/dev/null)" ]; then
            echo "No torrent files found in R2 testing bucket"
            exit 1
          fi

      - name: Determine Release Version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -eoux pipefail
          YEAR_MONTH=$(date -u +%y.%m)

          if gh release view "${YEAR_MONTH}" >/dev/null 2>&1; then
            PATCH=1
            while gh release view "${YEAR_MONTH}.${PATCH}" >/dev/null 2>&1; do
              PATCH=$((PATCH + 1))
            done
            VERSION="${YEAR_MONTH}.${PATCH}"
          else
            VERSION="${YEAR_MONTH}"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          TRIGGER_WORKFLOW: ${{ github.event.workflow_run.name }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          set -eoux pipefail

          TORRENT_LIST=""
          for f in torrents/*.torrent torrents/*.torrent-CHECKSUM; do
            [ -f "$f" ] && TORRENT_LIST="${TORRENT_LIST} ${f}"
          done

          gh release create "${VERSION}" \
            --title "Bluefin ISOs ${VERSION}" \
            --notes "$(cat <<'EOF'
          ## Bluefin ISO Torrents

          ### How to Download

          1. Download a `.torrent` file below
          2. Open with a BitTorrent client (qBittorrent, Transmission, etc.)
          3. Torrents include web seeds -- downloads work immediately

          ### Direct Downloads

          ISOs are also available at https://download.projectbluefin.io/

          ### Verify

          sha256sum -c <filename>.torrent-CHECKSUM
          EOF
          )" \
            ${TORRENT_LIST}
