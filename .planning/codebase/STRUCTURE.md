# Codebase Structure

**Analysis Date:** 2026-01-28

## Directory Layout

```
iso/
├── .github/                # GitHub-specific configuration
│   └── workflows/          # GitHub Actions CI/CD workflows
├── .planning/              # Project planning and documentation
│   └── codebase/           # Architecture/structure analysis
├── hack/                   # Developer utilities and helper scripts
├── iso_files/              # ISO generation configuration
├── just/                   # Additional Just recipe modules
├── .gitignore              # Git ignore patterns
├── .pre-commit-config.yaml # Pre-commit hook configuration
├── AGENTS.md               # AI agent/copilot instructions
├── CONTRIBUTING.md         # Contribution guidelines
├── Justfile                # Build automation recipes
├── LICENSE                 # Apache 2.0 license
├── README.md               # Repository documentation
└── WORKFLOW_FIX.md         # Workflow troubleshooting notes
```

## Directory Purposes

**.github/workflows/**
- Purpose: GitHub Actions workflow definitions for ISO builds and validation
- Contains: YAML workflow files for CI/CD pipelines
- Key files:
  - `reusable-build-iso-anaconda.yml`: Core reusable build logic with matrix strategy
  - `build-iso-stable.yml`: Caller workflow for Stable ISOs (amd64 × main/nvidia-open)
  - `build-iso-lts.yml`: Caller workflow for LTS ISOs (amd64/arm64 × main/gdx)
  - `build-iso-lts-hwe.yml`: Caller workflow for LTS-HWE ISOs (amd64/arm64 × main)
  - `build-iso-all.yml`: Orchestrator workflow calling all three ISO workflows
  - `promote-iso.yml`: Production promotion workflow with dry-run support
  - `pull-request.yml`: PR validation workflow
  - `validate-renovate.yml`: Renovate configuration validation

**iso_files/**
- Purpose: ISO customization scripts and configuration files
- Contains: Shell scripts executed during ISO generation, repository configurations
- Key files:
  - `configure_iso_anaconda.sh`: Hook script for Stable ISOs (Fedora-based)
  - `configure_lts_iso_anaconda.sh`: Hook script for LTS ISOs (CentOS-based)
  - `bluefin.repo`: Generated COPR repository file (not committed)
  - `README.md`: Documentation about ISO files

**just/**
- Purpose: Modular Just recipe collections for user/system management
- Contains: Just files with grouped recipes (imported by main Justfile)
- Key files:
  - `bluefin-apps.just`: User-facing application management recipes (3809 bytes)
  - `bluefin-system.just`: System management recipes (8035 bytes)

**hack/**
- Purpose: Developer helper scripts for local development
- Contains: Utility scripts for local ISO building and testing
- Key files:
  - `local-iso-build.sh`: Local Titanoboa-based ISO build script

**.planning/codebase/**
- Purpose: Architecture and structure documentation generated by GSD mapping
- Contains: Analysis documents (ARCHITECTURE.md, STRUCTURE.md, etc.)
- Key files: Architecture analysis, directory structure, conventions, testing patterns

**flatpaks/** (deprecated in workflow)
- Purpose: Previously stored flatpak list files
- Contains: List files with flatpak application IDs (no longer used by workflows)
- Key files: `system-flatpaks.list`, `system-flatpaks-dx.list`, `system-flatpaks-extra.list`
- Note: Workflows now fetch flatpaks from projectbluefin/common repository

## Key File Locations

**Entry Points:**
- `Justfile`: Main build automation entry point (906 lines)
- `.github/workflows/reusable-build-iso-anaconda.yml`: Core workflow logic (235 lines)
- `.github/workflows/build-iso-{lts,lts-hwe,stable}.yml`: Caller workflow entry points

**Configuration:**
- `.pre-commit-config.yaml`: Pre-commit hook configuration (YAML/JSON/TOML validation)
- `iso_files/configure_iso_anaconda.sh`: Standard ISO configuration (208 lines)
- `iso_files/configure_lts_iso_anaconda.sh`: LTS ISO configuration (208 lines)

**Core Logic:**
- `Justfile` lines 456-597: `build-iso` recipe - main ISO build logic
- `Justfile` lines 69-97: `validate` recipe - image/tag/flavor validation
- `Justfile` lines 754-763: `image_name` recipe - image name formatting
- `.github/workflows/reusable-build-iso-anaconda.yml` lines 47-107: Matrix determination logic
- `.github/workflows/reusable-build-iso-anaconda.yml` lines 182-189: Titanoboa ISO build invocation

**Testing:**
- `Justfile` lines 600-637: `run-iso` recipe - test ISO in VM
- `.github/workflows/pull-request.yml`: PR validation workflow

**Documentation:**
- `README.md`: Repository documentation with workflow architecture diagrams
- `AGENTS.md`: Comprehensive copilot instructions (36088 bytes)
- `CONTRIBUTING.md`: Contribution guidelines
- `WORKFLOW_FIX.md`: Workflow troubleshooting documentation

## Naming Conventions

**Files:**
- Workflows: `build-iso-{variant}.yml` pattern (e.g., `build-iso-lts.yml`)
- Configuration scripts: `configure_{variant}_iso_anaconda.sh` pattern
- Just modules: `{scope}-{purpose}.just` pattern (e.g., `bluefin-apps.just`)
- Helper scripts: `{purpose}.sh` in `hack/` directory (kebab-case)

**Directories:**
- Lowercase with underscores for multi-word names: `iso_files/`
- Hidden directories use dot prefix: `.github/`, `.planning/`
- Hyphenated for GitHub Actions: `.github/workflows/`

**Workflow Jobs:**
- Caller workflows: `build-iso-{variant}` job name
- Reusable workflow: `determine-matrix` and `build` job names
- Descriptive display names: "Build LTS ISOs", "Determine Build Matrix"

**Variables:**
- Workflow inputs: snake_case (`image_version`, `upload_artifacts`)
- Matrix keys: snake_case (`image_version`, `platform`, `flavor`)
- Environment variables: UPPER_SNAKE_CASE (`IMAGE_REGISTRY`, `IMAGE_NAME`)
- Just variables: snake_case (`repo_organization`, `images`, `flavors`)

**Variants:**
- Release streams: lowercase (`stable`, `lts`, `lts-hwe`)
- Flavors: lowercase (`main`, `nvidia-open`, `gdx`)
- Platforms: lowercase (`amd64`, `arm64`)

## Where to Add New Code

**New ISO Variant:**
- Primary code: Add case to `.github/workflows/reusable-build-iso-anaconda.yml` determine-matrix job (lines 56-93)
- Caller workflow: Create new `.github/workflows/build-iso-{variant}.yml` following standard pattern
- Hook script: Add `iso_files/configure_{variant}_iso_anaconda.sh` if custom configuration needed
- Tests: Add to validation workflow or test locally with `just build-iso-ghcr bluefin {variant} main`

**New Flatpak List:**
- Implementation: Workflow now fetches from projectbluefin/common repository
- Local testing: Modify `hack/local-iso-build.sh` flatpaks_source parameter
- Note: `flatpaks/` directory files are deprecated in workflows

**New Configuration Script:**
- Implementation: `iso_files/configure_{purpose}.sh`
- Reference in workflow: Update Titanoboa `hook-post-rootfs` parameter in reusable workflow
- Testing: Validate syntax with `bash -n iso_files/configure_{purpose}.sh`

**New Just Recipe:**
- Modular recipes: `just/{scope}-{purpose}.just`
- Main recipes: Add to `Justfile` in appropriate group
- Helper recipes: Mark with `[private]` attribute if not user-facing

**New Workflow:**
- Caller workflow: `.github/workflows/build-iso-{variant}.yml` (use standard template)
- Reusable logic: Modify `.github/workflows/reusable-build-iso-anaconda.yml`
- Validation: `.github/workflows/validate-{purpose}.yml`
- CRITICAL: Follow standard caller workflow pattern (no permissions block, use secrets: inherit)

**Utilities:**
- Shared helpers: `hack/{utility-name}.sh`
- Build helpers: Add Just recipe to `Justfile`

## Special Directories

**.github/workflows/**
- Purpose: CI/CD automation and build orchestration
- Generated: No
- Committed: Yes

**.planning/codebase/**
- Purpose: Architecture documentation generated by GSD mapping commands
- Generated: Yes (by `/gsd-map-codebase`)
- Committed: Yes

**hack/**
- Purpose: Developer utilities not part of main build process
- Generated: No
- Committed: Yes

**flatpaks/** (deprecated)
- Purpose: Previously stored flatpak application lists
- Generated: No
- Committed: Yes (legacy files remain)
- Note: No longer used by workflows - flatpaks fetched from projectbluefin/common

**iso_files/**
- Purpose: ISO generation configuration and hooks
- Generated: Partially (`bluefin.repo` generated during build, not committed)
- Committed: Yes (except generated files)

## Workflow File Architecture

**Caller Workflow Pattern:**
Location: `.github/workflows/build-iso-{lts,lts-hwe,stable}.yml`
Structure:
- Triggers: `workflow_dispatch` with inputs, `schedule` with cron
- Single job calling reusable workflow
- NO permissions block (inherited from reusable workflow)
- `secrets: inherit` to pass repository secrets
- Three inputs passed: `image_version`, `upload_artifacts`, `upload_r2`

**Reusable Workflow Pattern:**
Location: `.github/workflows/reusable-build-iso-anaconda.yml`
Structure:
- Two jobs: `determine-matrix` and `build`
- Matrix generation based on `image_version` input
- Permissions managed centrally (contents:read, packages:read, id-token:write)
- Parallel builds across matrix entries
- Conditional uploads based on event type and inputs

**Orchestrator Workflow Pattern:**
Location: `.github/workflows/build-iso-all.yml`
Structure:
- Triggers: `workflow_dispatch` with inputs, `schedule` with cron
- Multiple jobs calling other caller workflows in parallel
- Passes through upload configuration to all workflows

## Build Artifact Structure

**ISO Build Output:**
```
{image_name}_build/
├── {image_name}-{tag}-{arch}.iso           # Bootable ISO file
├── {image_name}-{tag}-{arch}.iso-CHECKSUM  # SHA256 checksum
└── flatpaks-with-deps                      # Flatpak list with dependencies (deprecated in workflow)
```

**GitHub Actions Artifacts:**
- Name: `{image_name}-{image_version}-{arch}` (e.g., `bluefin-stable-x86_64`)
- Contents: ISO file and checksum

**CloudFlare R2 Structure:**
- Bucket: `testing` (automatic builds)
- Bucket: `prodtest` (promoted releases)
- Files: ISOs and checksums uploaded directly to bucket root

## Configuration File Relationships

**Workflow Chain:**
```
build-iso-{variant}.yml (caller)
    ↓ calls
reusable-build-iso-anaconda.yml
    ↓ uses
Justfile (image_name recipe)
    ↓ determines
Image reference
    ↓ passed to
Titanoboa builder
    ↓ executes
configure_{variant}_iso_anaconda.sh
    ↓ configures
Anaconda installer and live environment
```

**Just Recipe Imports:**
```
Justfile (main recipes)
    ↓ imports (conceptually)
just/bluefin-apps.just (application management)
just/bluefin-system.just (system management)
```
Note: Currently Just doesn't support explicit imports; these are separate recipe collections

**Validation Chain:**
```
Developer commit
    ↓ triggers
pre-commit hooks (.pre-commit-config.yaml)
    ↓ validates
YAML/JSON/TOML syntax
    ↓ also runs
just check (Justfile validation)
    ↓ ensures
All Just files have valid syntax
```

---

*Structure analysis: 2026-01-28*
